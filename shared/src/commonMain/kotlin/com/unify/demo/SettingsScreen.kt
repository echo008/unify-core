package com.unify.demo

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.unify.core.ui.components.*
import com.unify.core.mvi.*
import com.unify.core.performance.UnifyComposeOptimizer.PerformanceTracker
import kotlinx.coroutines.CoroutineScope

/**
 * ËÆæÁΩÆÂ±èÂπï - Â±ïÁ§∫‰∏ªÈ¢òÂàáÊç¢ÂíåÂÅèÂ•ΩËÆæÁΩÆ
 */
@Composable
fun SettingsScreen(
    onNavigateBack: () -> Unit
) {
    val scope = rememberCoroutineScope()
    val viewModel = remember { SettingsViewModel(scope) }
    
    PerformanceTracker("SettingsScreen") {
        UnifyMVIContainer(
            stateManager = viewModel,
            onEffect = { effect ->
                when (effect) {
                    is SettingsEffect.ShowMessage -> {
                        // ÊòæÁ§∫Ê∂àÊÅØ
                    }
                    is SettingsEffect.RestartRequired -> {
                        // ÊèêÁ§∫ÈúÄË¶ÅÈáçÂêØ
                    }
                }
            }
        ) { state, isLoading, onIntent ->
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // È°∂ÈÉ®Ê†è
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    UnifyButton(
                        onClick = onNavigateBack,
                        text = "‚Üê ËøîÂõû"
                    )
                    Text(
                        text = "Â∫îÁî®ËÆæÁΩÆ",
                        style = MaterialTheme.typography.headlineSmall
                    )
                    Spacer(modifier = Modifier.width(80.dp))
                }
                
                // Â§ñËßÇËÆæÁΩÆ
                UnifyCard {
                    Column(
                        verticalArrangement = Arrangement.spacedBy(16.dp)
                    ) {
                        Text(
                            text = "üé® Â§ñËßÇËÆæÁΩÆ",
                            style = MaterialTheme.typography.titleMedium,
                            color = MaterialTheme.colorScheme.primary
                        )
                        
                        // ‰∏ªÈ¢òÂàáÊç¢
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween,
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Column {
                                Text(
                                    text = "Ê∑±Ëâ≤‰∏ªÈ¢ò",
                                    style = MaterialTheme.typography.bodyLarge
                                )
                                Text(
                                    text = "ÂàáÊç¢Â∫îÁî®‰∏ªÈ¢òÊ®°Âºè",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                            Switch(
                                checked = state.isDarkTheme,
                                onCheckedChange = { onIntent(SettingsIntent.ToggleTheme) }
                            )
                        }
                        
                        // Âä®ÊÄÅÈ¢úËâ≤
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween,
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Column {
                                Text(
                                    text = "Âä®ÊÄÅÈ¢úËâ≤",
                                    style = MaterialTheme.typography.bodyLarge
                                )
                                Text(
                                    text = "Ê†πÊçÆÂ£ÅÁ∫∏Ë∞ÉÊï¥Â∫îÁî®È¢úËâ≤",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                            Switch(
                                checked = state.isDynamicColor,
                                onCheckedChange = { onIntent(SettingsIntent.ToggleDynamicColor) }
                            )
                        }
                    }
                }
                
                // ÊÄßËÉΩËÆæÁΩÆ
                UnifyCard {
                    Column(
                        verticalArrangement = Arrangement.spacedBy(16.dp)
                    ) {
                        Text(
                            text = "‚ö° ÊÄßËÉΩËÆæÁΩÆ",
                            style = MaterialTheme.typography.titleMedium,
                            color = MaterialTheme.colorScheme.primary
                        )
                        
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween,
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Column {
                                Text(
                                    text = "ÊÄßËÉΩÁõëÊéß",
                                    style = MaterialTheme.typography.bodyLarge
                                )
                                Text(
                                    text = "ÂêØÁî®ÂÆûÊó∂ÊÄßËÉΩÁõëÊéß",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                            Switch(
                                checked = state.isPerformanceMonitorEnabled,
                                onCheckedChange = { onIntent(SettingsIntent.TogglePerformanceMonitor) }
                            )
                        }
                        
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween,
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Column {
                                Text(
                                    text = "Âä®ÁîªÊïàÊûú",
                                    style = MaterialTheme.typography.bodyLarge
                                )
                                Text(
                                    text = "ÂêØÁî®ÁïåÈù¢Âä®ÁîªÊïàÊûú",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                            Switch(
                                checked = state.isAnimationEnabled,
                                onCheckedChange = { onIntent(SettingsIntent.ToggleAnimation) }
                            )
                        }
                    }
                }
                
                // Êï∞ÊçÆËÆæÁΩÆ
                UnifyCard {
                    Column(
                        verticalArrangement = Arrangement.spacedBy(16.dp)
                    ) {
                        Text(
                            text = "üíæ Êï∞ÊçÆËÆæÁΩÆ",
                            style = MaterialTheme.typography.titleMedium,
                            color = MaterialTheme.colorScheme.primary
                        )
                        
                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween,
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Column {
                                Text(
                                    text = "Ëá™Âä®ÂêåÊ≠•",
                                    style = MaterialTheme.typography.bodyLarge
                                )
                                Text(
                                    text = "Ëá™Âä®ÂêåÊ≠•Êï∞ÊçÆÂà∞‰∫ëÁ´Ø",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                            Switch(
                                checked = state.isAutoSyncEnabled,
                                onCheckedChange = { onIntent(SettingsIntent.ToggleAutoSync) }
                            )
                        }
                        
                        UnifyButton(
                            onClick = { onIntent(SettingsIntent.ClearCache) },
                            text = "Ê∏ÖÈô§ÁºìÂ≠ò",
                            modifier = Modifier.fillMaxWidth()
                        )
                    }
                }
                
                // ÂÖ≥‰∫é‰ø°ÊÅØ
                UnifyCard {
                    Column(
                        verticalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Text(
                            text = "‚ÑπÔ∏è ÂÖ≥‰∫éÂ∫îÁî®",
                            style = MaterialTheme.typography.titleMedium,
                            color = MaterialTheme.colorScheme.primary
                        )
                        
                        InfoRow("Â∫îÁî®ÁâàÊú¨", "1.0.0")
                        InfoRow("ÊûÑÂª∫ÁâàÊú¨", "2024.08.30")
                        InfoRow("Kotlin ÁâàÊú¨", "1.9.22")
                        InfoRow("Compose ÁâàÊú¨", "1.5.12")
                        InfoRow("Âπ≥Âè∞ÊîØÊåÅ", "Android, iOS, Desktop, Web")
                    }
                }
            }
        }
    }
}

/**
 * ËÆæÁΩÆ MVI ÂÆûÁé∞
 */
data class SettingsState(
    val isDarkTheme: Boolean = false,
    val isDynamicColor: Boolean = true,
    val isPerformanceMonitorEnabled: Boolean = true,
    val isAnimationEnabled: Boolean = true,
    val isAutoSyncEnabled: Boolean = true
) : UnifyState

sealed class SettingsIntent : UnifyIntent {
    object ToggleTheme : SettingsIntent()
    object ToggleDynamicColor : SettingsIntent()
    object TogglePerformanceMonitor : SettingsIntent()
    object ToggleAnimation : SettingsIntent()
    object ToggleAutoSync : SettingsIntent()
    object ClearCache : SettingsIntent()
    object LoadSettings : SettingsIntent()
    object SaveSettings : SettingsIntent()
}

sealed class SettingsEffect : UnifyEffect {
    data class ShowMessage(val message: String) : SettingsEffect()
    object RestartRequired : SettingsEffect()
}

class SettingsViewModel(scope: CoroutineScope) : UnifyViewModel<SettingsIntent, SettingsState, SettingsEffect>(
    initialState = SettingsState(),
    scope = scope
) {
    
    init {
        handleIntent(SettingsIntent.LoadSettings)
    }
    
    override fun handleIntent(intent: SettingsIntent) {
        when (intent) {
            SettingsIntent.ToggleTheme -> {
                updateState { state ->
                    state.copy(isDarkTheme = !state.isDarkTheme)
                }
                handleIntent(SettingsIntent.SaveSettings)
                sendEffect(SettingsEffect.ShowMessage("‰∏ªÈ¢òÂ∑≤ÂàáÊç¢"))
            }
            
            SettingsIntent.ToggleDynamicColor -> {
                updateState { state ->
                    state.copy(isDynamicColor = !state.isDynamicColor)
                }
                handleIntent(SettingsIntent.SaveSettings)
                sendEffect(SettingsEffect.ShowMessage("Âä®ÊÄÅÈ¢úËâ≤ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞"))
            }
            
            SettingsIntent.TogglePerformanceMonitor -> {
                updateState { state ->
                    state.copy(isPerformanceMonitorEnabled = !state.isPerformanceMonitorEnabled)
                }
                handleIntent(SettingsIntent.SaveSettings)
                sendEffect(SettingsEffect.ShowMessage("ÊÄßËÉΩÁõëÊéßËÆæÁΩÆÂ∑≤Êõ¥Êñ∞"))
            }
            
            SettingsIntent.ToggleAnimation -> {
                updateState { state ->
                    state.copy(isAnimationEnabled = !state.isAnimationEnabled)
                }
                handleIntent(SettingsIntent.SaveSettings)
                sendEffect(SettingsEffect.ShowMessage("Âä®ÁîªËÆæÁΩÆÂ∑≤Êõ¥Êñ∞"))
            }
            
            SettingsIntent.ToggleAutoSync -> {
                updateState { state ->
                    state.copy(isAutoSyncEnabled = !state.isAutoSyncEnabled)
                }
                handleIntent(SettingsIntent.SaveSettings)
                sendEffect(SettingsEffect.ShowMessage("Ëá™Âä®ÂêåÊ≠•ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞"))
            }
            
            SettingsIntent.ClearCache -> {
                handleAsyncIntent(intent) {
                    kotlinx.coroutines.delay(1000)
                    sendEffect(SettingsEffect.ShowMessage("ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§"))
                }
            }
            
            SettingsIntent.LoadSettings -> {
                handleAsyncIntent(intent) {
                    // Ê®°ÊãüÂä†ËΩΩËÆæÁΩÆ
                    kotlinx.coroutines.delay(500)
                    // ËÆæÁΩÆÂ∑≤Âä†ËΩΩÂà∞ÂàùÂßãÁä∂ÊÄÅ
                }
            }
            
            SettingsIntent.SaveSettings -> {
                handleAsyncIntent(intent) {
                    // Ê®°Êãü‰øùÂ≠òËÆæÁΩÆ
                    kotlinx.coroutines.delay(200)
                    // ËÆæÁΩÆÂ∑≤‰øùÂ≠ò
                }
            }
        }
    }
}

@Composable
private fun InfoRow(
    label: String,
    value: String
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Text(
            text = label,
            style = MaterialTheme.typography.bodyMedium,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
        Text(
            text = value,
            style = MaterialTheme.typography.bodyMedium
        )
    }
}

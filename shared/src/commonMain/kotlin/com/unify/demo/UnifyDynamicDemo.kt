package com.unify.demo

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.unify.ui.components.container.UnifySection
import com.unify.ui.components.feedback.UnifyProgress
import kotlinx.coroutines.delay

/**
 * UnifyÂä®ÊÄÅÁªÑ‰ª∂ÊºîÁ§∫ÁïåÈù¢
 * Â±ïÁ§∫Ë∑®Âπ≥Âè∞Âä®ÊÄÅÂä†ËΩΩÂíåÁÉ≠Êõ¥Êñ∞ÂäüËÉΩ
 */

data class DynamicComponent(
    val id: String,
    val name: String,
    val version: String,
    val status: ComponentStatus,
    val description: String,
    val size: String,
    val lastUpdated: String
)

enum class ComponentStatus {
    INSTALLED, AVAILABLE, UPDATING, ERROR
}

data class UpdateInfo(
    val componentId: String,
    val currentVersion: String,
    val newVersion: String,
    val updateSize: String,
    val changelog: List<String>
)

@Composable
fun UnifyDynamicDemo(
    modifier: Modifier = Modifier
) {
    var components by remember { mutableStateOf(getDefaultComponents()) }
    var availableUpdates by remember { mutableStateOf(getAvailableUpdates()) }
    var isRefreshing by remember { mutableStateOf(false) }
    var selectedTab by remember { mutableStateOf(0) }
    
    LazyColumn(
        modifier = modifier.fillMaxSize(),
        contentPadding = PaddingValues(16.dp),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        item {
            DynamicSystemHeader(
                onRefresh = {
                    isRefreshing = true
                    // Ê®°ÊãüÂà∑Êñ∞
                },
                isRefreshing = isRefreshing
            )
        }
        
        item {
            TabRow(selectedTabIndex = selectedTab) {
                Tab(
                    selected = selectedTab == 0,
                    onClick = { selectedTab = 0 },
                    text = { Text("Â∑≤ÂÆâË£Ö") }
                )
                Tab(
                    selected = selectedTab == 1,
                    onClick = { selectedTab = 1 },
                    text = { Text("ÂèØÁî®Êõ¥Êñ∞") }
                )
                Tab(
                    selected = selectedTab == 2,
                    onClick = { selectedTab = 2 },
                    text = { Text("ÁªÑ‰ª∂ÂïÜÂ∫ó") }
                )
            }
        }
        
        when (selectedTab) {
            0 -> {
                items(components.filter { it.status == ComponentStatus.INSTALLED }) { component ->
                    InstalledComponentCard(
                        component = component,
                        onUninstall = { componentId ->
                            components = components.map { comp ->
                                if (comp.id == componentId) {
                                    comp.copy(status = ComponentStatus.AVAILABLE)
                                } else comp
                            }
                        }
                    )
                }
            }
            1 -> {
                items(availableUpdates) { update ->
                    UpdateCard(
                        update = update,
                        onUpdate = { updateId ->
                            // Â§ÑÁêÜÊõ¥Êñ∞
                        }
                    )
                }
            }
            2 -> {
                items(components.filter { it.status == ComponentStatus.AVAILABLE }) { component ->
                    AvailableComponentCard(
                        component = component,
                        onInstall = { componentId ->
                            components = components.map { comp ->
                                if (comp.id == componentId) {
                                    comp.copy(status = ComponentStatus.UPDATING)
                                } else comp
                            }
                        }
                    )
                }
            }
        }
    }
    
    LaunchedEffect(isRefreshing) {
        if (isRefreshing) {
            delay(2000)
            isRefreshing = false
        }
    }
}

@Composable
private fun DynamicSystemHeader(
    onRefresh: () -> Unit,
    isRefreshing: Boolean,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.primaryContainer
        )
    ) {
        Column(
            modifier = Modifier.padding(20.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column {
                    Text(
                        text = "üîÑ Âä®ÊÄÅÁªÑ‰ª∂Á≥ªÁªü",
                        style = MaterialTheme.typography.headlineMedium,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onPrimaryContainer
                    )
                    Text(
                        text = "ÂÆûÊó∂ÁªÑ‰ª∂ÁÆ°ÁêÜÂíåÁÉ≠Êõ¥Êñ∞",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onPrimaryContainer.copy(alpha = 0.8f)
                    )
                }
                
                IconButton(
                    onClick = onRefresh,
                    enabled = !isRefreshing
                ) {
                    if (isRefreshing) {
                        CircularProgressIndicator(
                            modifier = Modifier.size(24.dp),
                            strokeWidth = 2.dp
                        )
                    } else {
                        Text("üîÑ", style = MaterialTheme.typography.headlineSmall)
                    }
                }
            }
            
            Spacer(modifier = Modifier.height(16.dp))
            
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceEvenly
            ) {
                SystemStatusItem("Â∑≤ÂÆâË£Ö", "12", Color(0xFF4CAF50))
                SystemStatusItem("ÂèØÊõ¥Êñ∞", "3", Color(0xFFFF9800))
                SystemStatusItem("ÂèØÁî®", "8", Color(0xFF2196F3))
            }
        }
    }
}

@Composable
private fun SystemStatusItem(
    label: String,
    count: String,
    color: Color,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier,
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Text(
            text = count,
            style = MaterialTheme.typography.headlineMedium,
            fontWeight = FontWeight.Bold,
            color = color
        )
        Text(
            text = label,
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onPrimaryContainer
        )
    }
}

@Composable
private fun InstalledComponentCard(
    component: DynamicComponent,
    onUninstall: (String) -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth()
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.Top
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = component.name,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold
                    )
                    Text(
                        text = "ÁâàÊú¨ ${component.version}",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.primary
                    )
                    Text(
                        text = component.description,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
                
                Surface(
                    shape = MaterialTheme.shapes.small,
                    color = Color(0xFF4CAF50)
                ) {
                    Text(
                        text = "Â∑≤ÂÆâË£Ö",
                        style = MaterialTheme.typography.labelSmall,
                        color = Color.White,
                        modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)
                    )
                }
            }
            
            Spacer(modifier = Modifier.height(12.dp))
            
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column {
                    Text(
                        text = "Â§ßÂ∞è: ${component.size}",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    Text(
                        text = "Êõ¥Êñ∞: ${component.lastUpdated}",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
                
                OutlinedButton(
                    onClick = { onUninstall(component.id) },
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = MaterialTheme.colorScheme.error
                    )
                ) {
                    Text("Âç∏ËΩΩ")
                }
            }
        }
    }
}

@Composable
private fun UpdateCard(
    update: UpdateInfo,
    onUpdate: (String) -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.secondaryContainer
        )
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.Top
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = "ÁªÑ‰ª∂Êõ¥Êñ∞ÂèØÁî®",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold
                    )
                    Text(
                        text = "${update.currentVersion} ‚Üí ${update.newVersion}",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.primary
                    )
                }
                
                Surface(
                    shape = MaterialTheme.shapes.small,
                    color = Color(0xFFFF9800)
                ) {
                    Text(
                        text = "ÂèØÊõ¥Êñ∞",
                        style = MaterialTheme.typography.labelSmall,
                        color = Color.White,
                        modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)
                    )
                }
            }
            
            Spacer(modifier = Modifier.height(12.dp))
            
            Text(
                text = "Êõ¥Êñ∞ÂÜÖÂÆπ:",
                style = MaterialTheme.typography.bodyMedium,
                fontWeight = FontWeight.Medium
            )
            
            update.changelog.forEach { change ->
                Text(
                    text = "‚Ä¢ $change",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    modifier = Modifier.padding(start = 8.dp, top = 2.dp)
                )
            }
            
            Spacer(modifier = Modifier.height(12.dp))
            
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "Â§ßÂ∞è: ${update.updateSize}",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                
                Button(
                    onClick = { onUpdate(update.componentId) }
                ) {
                    Text("Êõ¥Êñ∞")
                }
            }
        }
    }
}

@Composable
private fun AvailableComponentCard(
    component: DynamicComponent,
    onInstall: (String) -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth()
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.Top
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = component.name,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold
                    )
                    Text(
                        text = "ÁâàÊú¨ ${component.version}",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.primary
                    )
                    Text(
                        text = component.description,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
                
                Surface(
                    shape = MaterialTheme.shapes.small,
                    color = Color(0xFF2196F3)
                ) {
                    Text(
                        text = "ÂèØÂÆâË£Ö",
                        style = MaterialTheme.typography.labelSmall,
                        color = Color.White,
                        modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)
                    )
                }
            }
            
            Spacer(modifier = Modifier.height(12.dp))
            
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "Â§ßÂ∞è: ${component.size}",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                
                Button(
                    onClick = { onInstall(component.id) }
                ) {
                    Text("ÂÆâË£Ö")
                }
            }
        }
    }
}

private fun getDefaultComponents(): List<DynamicComponent> {
    return listOf(
        DynamicComponent(
            id = "ui_enhanced",
            name = "Â¢ûÂº∫UIÁªÑ‰ª∂ÂåÖ",
            version = "2.1.0",
            status = ComponentStatus.INSTALLED,
            description = "Êèê‰æõÈ´òÁ∫ßUIÁªÑ‰ª∂ÂíåÂä®ÁîªÊïàÊûú",
            size = "2.3 MB",
            lastUpdated = "2Â§©Ââç"
        ),
        DynamicComponent(
            id = "analytics_pro",
            name = "‰∏ì‰∏öÂàÜÊûêÂ∑•ÂÖ∑",
            version = "1.5.2",
            status = ComponentStatus.INSTALLED,
            description = "È´òÁ∫ßÊï∞ÊçÆÂàÜÊûêÂíåÂèØËßÜÂåñÂäüËÉΩ",
            size = "1.8 MB",
            lastUpdated = "1Âë®Ââç"
        ),
        DynamicComponent(
            id = "camera_filters",
            name = "Áõ∏Êú∫Êª§ÈïúÂåÖ",
            version = "3.0.1",
            status = ComponentStatus.AVAILABLE,
            description = "‰∏∞ÂØåÁöÑÁõ∏Êú∫Êª§ÈïúÂíåÁâπÊïà",
            size = "4.2 MB",
            lastUpdated = "3Â§©Ââç"
        ),
        DynamicComponent(
            id = "ai_assistant",
            name = "AIÊô∫ËÉΩÂä©Êâã",
            version = "1.2.0",
            status = ComponentStatus.AVAILABLE,
            description = "Êô∫ËÉΩÂØπËØùÂíå‰ªªÂä°ËæÖÂä©ÂäüËÉΩ",
            size = "5.1 MB",
            lastUpdated = "1Â§©Ââç"
        )
    )
}

private fun getAvailableUpdates(): List<UpdateInfo> {
    return listOf(
        UpdateInfo(
            componentId = "ui_enhanced",
            currentVersion = "2.1.0",
            newVersion = "2.2.0",
            updateSize = "1.2 MB",
            changelog = listOf(
                "Êñ∞Â¢ûÊöóÈªëÊ®°ÂºèÊîØÊåÅ",
                "‰ºòÂåñÂä®ÁîªÊÄßËÉΩ",
                "‰øÆÂ§çÂ∑≤Áü•ÈóÆÈ¢ò"
            )
        ),
        UpdateInfo(
            componentId = "analytics_pro",
            currentVersion = "1.5.2",
            newVersion = "1.6.0",
            updateSize = "0.8 MB",
            changelog = listOf(
                "Êñ∞Â¢ûÂÆûÊó∂Êï∞ÊçÆÁõëÊéß",
                "Â¢ûÂº∫ÂõæË°®ÂäüËÉΩ",
                "ÊèêÂçáÊï∞ÊçÆÂ§ÑÁêÜÈÄüÂ∫¶"
            )
        )
    )
}

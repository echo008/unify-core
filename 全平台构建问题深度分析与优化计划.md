# Unify-Core 全平台构建问题深度分析与优化计划

## 当前项目实际状态分析

### 项目架构概览
- **项目类型**: Kotlin Multiplatform Compose 项目
- **支持平台**: Android、iOS、Desktop(JVM)、Web(JS)、HarmonyOS、小程序、TV、Watch等
- **核心技术栈**: Kotlin 2.1.0、Compose Multiplatform 1.6.11、Ktor、SQLDelight

### 实际构建测试结果

#### 1. 构建失败的根本原因
通过 `./gradlew build --stacktrace` 测试发现的具体错误：

**主要错误**: Android API版本不兼容
```
Dependency 'androidx.core:core:1.15.0' requires libraries and applications that
depend on it to compile against version 35 or later of the Android APIs.
:tvApp is currently compiled against android-34.
```

#### 2. 平台配置不一致问题

**Android平台配置差异**:
- `androidApp`: compileSdk = 35 ✅
- `tvApp`: compileSdk = 34 ❌ 
- `wearApp`: compileSdk = 34 ❌
- `watchApp`: 未检查
- `harmonyTVApp`: 未检查
- `harmonyWearApp`: 未检查

**依赖版本不统一**:
- `shared`模块: androidx.core:core-ktx:1.15.0
- `tvApp`: androidx.core:core-ktx:1.12.0
- `wearApp`: androidx.core:core-ktx:1.12.0

#### 3. 平台特定实现缺失

**HarmonyOS平台**:
- 当前通过linuxX64模拟，缺乏真实HarmonyOS支持
- 需要ArkUI框架集成
- 缺少HarmonyOS SDK配置

**小程序平台**:
- 仅有桥接层(miniAppBridge)
- 缺少具体小程序平台实现
- 需要各小程序平台适配层

**TV和Watch平台**:
- 基础配置存在，但API版本过时
- 缺少平台特定功能实现

## 具体构建错误清单

### 1. 编译SDK版本问题
- [ ] tvApp compileSdk需要从34升级到35
- [ ] wearApp compileSdk需要从34升级到35  
- [ ] watchApp compileSdk需要检查并统一
- [ ] harmonyTVApp compileSdk需要检查并统一
- [ ] harmonyWearApp compileSdk需要检查并统一

### 2. 依赖版本不统一
- [ ] 统一所有模块的androidx.core版本到1.15.0
- [ ] 统一androidx.activity版本到1.9.3
- [ ] 统一androidx.lifecycle版本到2.8.7
- [ ] 统一kotlinx.coroutines版本到1.9.0

### 3. 平台特定依赖缺失
- [ ] HarmonyOS平台缺少ArkUI支持
- [ ] 小程序平台缺少具体实现
- [ ] TV平台Leanback库版本过时
- [ ] Wear平台Health Services配置不完整

### 4. 构建脚本配置问题
- [ ] Gradle插件版本需要统一
- [ ] 构建任务定义不完整
- [ ] 平台特定构建逻辑缺失

## 全面优化计划

### 阶段一: 基础构建修复 (高优先级)

#### 任务1: 统一Android API版本
**目标**: 解决当前构建失败问题
**具体操作**:
1. 将所有Android相关模块的compileSdk统一为35
2. 更新所有targetSdk到35
3. 统一minSdk配置策略

#### 任务2: 依赖版本统一化
**目标**: 消除版本冲突
**具体操作**:
1. 在libs.versions.toml中定义所有版本
2. 所有模块使用统一版本引用
3. 移除硬编码版本号

#### 任务3: 修复构建脚本
**目标**: 确保基础构建通过
**具体操作**:
1. 修复tvApp构建配置
2. 修复wearApp构建配置
3. 验证所有现有平台构建

### 阶段二: 平台特定功能完善 (中优先级)

#### 任务4: HarmonyOS平台真实支持
**目标**: 实现真正的HarmonyOS应用
**技术方案**:
1. 集成HarmonyOS SDK
2. 实现ArkUI适配层
3. 创建HarmonyOS特定构建逻辑

#### 任务5: 小程序平台完整实现
**目标**: 支持主流小程序平台
**支持平台**:
- 微信小程序
- 支付宝小程序  
- 字节跳动小程序
- 百度智能小程序
- 快手小程序
- 小米小程序
- 华为快应用
- QQ小程序

#### 任务6: TV和Watch平台优化
**目标**: 完善大屏和穿戴设备支持
**具体操作**:
1. 更新TV Compose库到最新版本
2. 完善Wear OS Health Services集成
3. 添加watchOS支持(通过iOS变体)
4. 实现HarmonyOS TV和穿戴支持

### 阶段三: 高级功能和优化 (低优先级)

#### 任务7: 性能优化
**目标**: 提升应用性能和包体积
**具体操作**:
1. 启用R8代码混淆
2. 优化资源打包
3. 实现按需加载

#### 任务8: 开发工具完善
**目标**: 提升开发效率
**具体操作**:
1. 完善构建脚本
2. 添加自动化测试
3. 集成CI/CD流水线

#### 任务9: 文档和示例
**目标**: 完善项目文档
**具体操作**:
1. 更新README文档
2. 创建平台特定开发指南
3. 提供完整示例代码

## 技术实现细节

### HarmonyOS集成方案
```kotlin
// 预期的HarmonyOS目标配置
harmonyos("harmonyos") {
    binaries {
        executable {
            entryPoint = "com.unify.harmonyos.main"
        }
    }
}
```

### 小程序适配架构
```
miniApp/
├── wechat/          # 微信小程序
├── alipay/          # 支付宝小程序
├── bytedance/       # 字节跳动小程序
├── baidu/           # 百度智能小程序
├── kuaishou/        # 快手小程序
├── xiaomi/          # 小米小程序
├── huawei/          # 华为快应用
└── qq/              # QQ小程序
```

### 统一版本管理策略
```toml
[versions]
android-compile-sdk = "35"
android-target-sdk = "35" 
android-min-sdk = "24"
androidx-core = "1.15.0"
androidx-activity = "1.9.3"
androidx-lifecycle = "2.8.7"
```

## 验证标准

### 构建验证
- [ ] `./gradlew build` 成功执行
- [ ] 所有平台模块编译通过
- [ ] 无版本冲突警告
- [ ] 无弃用API警告

### 功能验证  
- [ ] Android应用正常运行
- [ ] iOS应用正常运行(需要macOS环境)
- [ ] Desktop应用正常运行
- [ ] Web应用正常运行
- [ ] TV应用在模拟器中运行
- [ ] Wear应用在模拟器中运行

### 平台特定验证
- [ ] HarmonyOS应用在DevEco Studio中构建
- [ ] 各小程序平台在对应开发工具中构建
- [ ] 所有平台核心功能正常

## 风险评估与缓解

### 高风险项
1. **HarmonyOS官方支持**: 当前KMP对HarmonyOS支持有限
   - **缓解**: 先通过Native层桥接实现
   
2. **小程序平台差异**: 各平台API和限制不同
   - **缓解**: 创建统一抽象层，平台特定实现

3. **iOS构建环境**: 需要macOS和Xcode
   - **缓解**: 在CI/CD中配置macOS runner

### 中风险项
1. **版本兼容性**: 新版本可能引入破坏性变更
   - **缓解**: 逐步升级，充分测试
   
2. **构建时间**: 多平台构建耗时较长
   - **缓解**: 并行构建，缓存优化

## 执行时间表

### 第1周: 基础修复
- 修复当前构建错误
- 统一版本配置
- 验证基础平台构建

### 第2-3周: 平台完善
- 实现HarmonyOS支持
- 完善小程序平台
- 优化TV和Watch支持

### 第4周: 测试和优化
- 全平台功能测试
- 性能优化
- 文档完善

## 成功标准

项目达到以下标准即为成功:
1. 所有目标平台构建成功
2. 核心功能在所有平台正常运行
3. 代码质量符合生产标准
4. 文档完整，易于维护
5. CI/CD流水线稳定运行

---

**更新时间**: 2025-09-10
**状态**: 待执行
**负责人**: 开发团队
